apiVersion: ray.io/v1
kind: RayService
metadata:
  name: recommendation-service
  namespace: ecommerce-platform
spec:
  serviceUnhealthySecondThreshold: 300
  deploymentUnhealthySecondThreshold: 300
  serveConfigV2: |
    applications:
      - name: recommendation_app
        import_path: serve_recommendations:app
        runtime_env:
          pip:
            - numpy<2
            - pandas
            - boto3
            - starlette
            - requests
          env_vars:
            MINIO_ENDPOINT: "http://minio:9000"
            MINIO_ACCESS_KEY: "minioadmin"
            MINIO_SECRET_KEY: "minioadmin"
            MODEL_S3_BUCKET: "warehouse"
            MODEL_KEY: "models/recommendation_model.pkl"
        route_prefix: /recommend
  rayClusterConfig:
    rayVersion: '2.46.0'
    headGroupSpec:
      rayStartParams:
        dashboard-host: '0.0.0.0'
      template:
        metadata:
          labels:
            app: ray
            component: serve-head
        spec:
          containers:
          - name: ray-head
            image: rayproject/ray:2.46.0
            ports:
            - containerPort: 6379
              name: gcs-server
            - containerPort: 8265
              name: dashboard
            - containerPort: 10001
              name: client
            - containerPort: 8000
              name: serve
            volumeMounts:
            - name: serve-script
              mountPath: /home/ray/serve_recommendations.py
              subPath: serve_recommendations.py
            resources:
              limits:
                cpu: "2"
                memory: "4Gi"
              requests:
                cpu: "1"
                memory: "2Gi"
          volumes:
          - name: serve-script
            configMap:
              name: ray-serve-script
    workerGroupSpecs:
    - replicas: 1
      minReplicas: 1
      maxReplicas: 2
      groupName: serve-workers
      rayStartParams: {}
      template:
        metadata:
          labels:
            app: ray
            component: serve-worker
        spec:
          containers:
          - name: ray-worker
            image: rayproject/ray:2.46.0
            volumeMounts:
            - name: serve-script
              mountPath: /home/ray/serve_recommendations.py
              subPath: serve_recommendations.py
            resources:
              limits:
                cpu: "2"
                memory: "4Gi"
              requests:
                cpu: "1"
                memory: "2Gi"
          volumes:
          - name: serve-script
            configMap:
              name: ray-serve-script
---
apiVersion: v1
kind: Service
metadata:
  name: recommendation-service-serve-svc
  namespace: ecommerce-platform
spec:
  selector:
    app: ray
    component: serve-head
  ports:
  - name: serve
    port: 8000
    targetPort: 8000
  type: ClusterIP
